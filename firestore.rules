rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secure user profiles at /users/{userId}.
     * @path /users/{userId}
     * @allow (create) - User with UID 'user123' can create their own profile document.
     * @allow (get) - User with UID 'user123' can read their own profile document.
     * @allow (update) - User with UID 'user123' can update their own profile document.
     * @allow (delete) - User with UID 'user123' can delete their own profile document.
     * @deny (create) - User with UID 'user456' cannot create a profile document for 'user123'.
     * @deny (get) - User with UID 'user456' cannot read the profile document for 'user123'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      // Check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Check if the requested userId matches the authenticated user's UID.
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      // Check if the requested userId matches the authenticated user's UID and resource exists.
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }
        allow get: if isSignedIn() && isOwner(userId);
        allow list: if false;
        allow create: if isSignedIn() && isOwner(userId);
        allow update: if isSignedIn() && isExistingOwner(userId);
        allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Secure device documents at /users/{userId}/devices/{deviceId}.
     * @path /users/{userId}/devices/{deviceId}
     * @allow (create) - User with UID 'user123' can create a device document under their ID.
     * @allow (get) - User with UID 'user123' can read a device document under their ID.
     * @allow (update) - User with UID 'user123' can update a device document under their ID.
     * @allow (delete) - User with UID 'user123' can delete a device document under their ID.
     * @deny (create) - User with UID 'user456' cannot create a device document under 'user123'.
     * @deny (get) - User with UID 'user456' cannot read a device document under 'user123'.
     * @principle Enforces document ownership and validates relational integrity on create.
     */
    match /users/{userId}/devices/{deviceId} {
       // Check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Check if the requested userId matches the authenticated user's UID.
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      // Check if the requested userId matches the authenticated user's UID and resource exists.
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }
        allow get: if isSignedIn() && isOwner(userId);
        allow list: if false;
        allow create: if isSignedIn() && isOwner(userId);
        allow update: if isSignedIn() && isExistingOwner(userId);
        allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Secure alert documents at /users/{userId}/devices/{deviceId}/alerts/{alertId}.
     * @path /users/{userId}/devices/{deviceId}/alerts/{alertId}
     * @allow (create) - User with UID 'user123' can create an alert document under their device.
     * @allow (get) - User with UID 'user123' can read an alert document under their device.
     * @allow (update) - User with UID 'user123' can update an alert document under their device.
     * @allow (delete) - User with UID 'user123' can delete an alert document under their device.
     * @deny (create) - User with UID 'user456' cannot create an alert document under 'user123'.
     * @deny (get) - User with UID 'user456' cannot read an alert document under 'user123'.
     * @principle Enforces document ownership and validates relational integrity.
     */
    match /users/{userId}/devices/{deviceId}/alerts/{alertId} {
       // Check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Check if the requested userId matches the authenticated user's UID.
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      // Check if the requested userId matches the authenticated user's UID and resource exists.
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }
        allow get: if isSignedIn() && isOwner(userId);
        allow list: if false;
        allow create: if isSignedIn() && isOwner(userId);
        allow update: if isSignedIn() && isExistingOwner(userId);
        allow delete: if isSignedIn() && isExistingOwner(userId);
    }
  }
}