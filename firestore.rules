/**
 * @description This ruleset enforces a strict user-ownership model for the SmartGas Guardian system.
 * All data is nested under /users/{userId}, ensuring users can only access their own data.
 *
 * @dataStructure
 * - /users/{userId}: Stores user profile information, with the document ID matching the Firebase Auth UID.
 * - /users/{userId}/devices/{deviceId}: Stores devices owned by the user.
 * - /users/{userId}/devices/{deviceId}/alerts/{alertId}: Stores alerts generated by a specific device.
 *
 * @keySecurityDecisions
 * - Users can only access their own documents and subcollections.
 * - Alerts are queryable across all alerts collections, but only those owned by the current user.
 * - Write access is restricted to the owner of the device.
 * - Data consistency is enforced between the path and the document's internal userId field.
 *
 * @denormalizationForAuthorization
 * - The `Alert` entity includes a `userId` field to simplify authorization checks. This allows rules to quickly verify ownership without additional `get()` calls.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Allow collection group queries for 'alerts' for authenticated users.
    // This rule is necessary for collectionGroup queries to pass initial security checks.

    /**
     * @description Allows users to read and write their own user document.
     * @path /users/{userId}
     * @allow (read, write) if the request is authenticated and the user ID matches the document ID.
     * @deny (read, write) if the request is not authenticated or the user ID does not match the document ID.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow read, write: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Allows users to manage their own devices.
     * @path /users/{userId}/devices/{deviceId}
     * @allow (create) if the request is authenticated and the user ID matches the parent document ID. Additionally, the userId in the request data must match the user ID in the path.
     * @allow (read, list) if the request is authenticated and the user ID matches the parent document ID.
     * @allow (update, delete) if the request is authenticated, the user ID matches the parent document ID, and the document exists. The userId field cannot be updated.
     * @deny (create, update, delete) if the request is not authenticated or the user ID does not match the parent document ID.
     * @principle Enforces document ownership and relational integrity.
     */
    match /users/{userId}/devices/{deviceId} {
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
      allow get, list: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId) && resource.data.userId == userId;
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Allows users to manage alerts for their devices.
     * @path /users/{userId}/devices/{deviceId}/alerts/{alertId}
     * @allow (create) if the request is authenticated and the user ID matches the grandparent document ID. Additionally, the userId in the request data must match the user ID in the path.
     * @allow (read, list) if the request is authenticated and the user ID matches the grandparent document ID.
     * @allow (update, delete) if the request is authenticated, the user ID matches the grandparent document ID, and the document exists. The userId field cannot be updated.
     * @deny (create, update, delete) if the request is not authenticated or the user ID does not match the grandparent document ID.
     * @principle Enforces document ownership and relational integrity.
     */
    match /users/{userId}/devices/{deviceId}/alerts/{alertId} {
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
      allow get, list: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId) && resource.data.userId == userId;
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    // ðŸ”” Allow querying across all 'alerts' collections â€” but only owned by current user
    // Assumes each alert document has a field: ownerId (string) == user.uid
    /**
     * @description Allows querying across all 'alerts' collections, but only for alerts owned by the current user.
     * @path /{path=**}/alerts/{alertId}
     * @allow (read) if the request is authenticated and the resource data's ownerId matches the user's ID.
     * @allow (create) if the request is authenticated and the resource data's ownerId matches the user's ID.
     * @allow (update, delete) if the request is authenticated and the resource data's ownerId matches the user's ID.
     * @deny (read, create, update, delete) if the request is not authenticated or the resource data's ownerId does not match the user's ID.
     * @principle Limits access to alerts based on ownership, ensuring users can only see their own alerts.
     */
    match /{path=**}/alerts/{alertId} {
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && isExistingOwnerAlert(resource.data.userId);
      allow delete: if isSignedIn() && isExistingOwnerAlert(resource.data.userId);
    }

  }
}

/**
 * @description Checks if the request is authenticated.
 * @return {boolean} True if the request is authenticated, false otherwise.
 */
function isSignedIn() {
  return request.auth != null;
}

/**
 * @description Checks if the user ID matches the authenticated user's ID.
 * @param {string} userId The user ID to check.
 * @return {boolean} True if the user ID matches the authenticated user's ID, false otherwise.
 */
function isOwner(userId) {
  return request.auth.uid == userId;
}

/**
 * @description Checks if the user is the owner of an existing document.
 * @param {string} userId The user ID to check.
 * @return {boolean} True if the user ID matches the authenticated user's ID and the document exists, false otherwise.
 */
function isExistingOwner(userId) {
    return isSignedIn() && isOwner(userId) && resource != null;
}

/**
 * @description Checks if the user is the owner of an existing alert document.
 * @param {string} userId The user ID to check.
 * @return {boolean} True if the user ID matches the authenticated user's ID and the alert document exists, false otherwise.
 */
function isExistingOwnerAlert(userId) {
    return isSignedIn() && userId == request.auth.uid && resource != null;
}