/**
 * @fileoverview Firestore Security Rules for SmartGas Guardian.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for all data. Each user
 * can only access their own data.
 *
 * Data Structure:
 * All data is nested under /users/{userId}, where {userId} is the Firebase Auth UID.
 *  - /users/{userId}: User profile information.
 *  - /users/{userId}/devices/{deviceId}: Devices owned by the user.
 *  - /users/{userId}/devices/{deviceId}/alerts/{alertId}: Alerts generated by a specific device.
 *
 * Key Security Decisions:
 *  - User listing is disallowed to protect user privacy.
 *  - All write operations require the user to be authenticated and the owner of the data.
 *
 * Denormalization for Authorization:
 * The 'Device' and 'Alert' entities both include a 'userId' field. This denormalization
 * is crucial for efficient security rules, as it allows us to verify ownership without
 * performing additional reads. For instance, when creating an alert, the rule verifies
 * that `request.resource.data.userId == request.auth.uid` and that `request.resource.data.deviceId` is valid.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces user-ownership for user profiles.
     * @path /users/{userId}
     * @allow (get) Authenticated user accessing their own profile.
     *     // Example: User with UID 'user123' reading /users/user123.
     * @deny (get) Authenticated user attempting to read another user's profile.
     *     // Example: User with UID 'user456' attempting to read /users/user123.
     * @allow (create) Authenticated user creating their profile.
     *     // Example: User with UID 'user123' creating /users/user123 with data { id: 'user123', ... }.
     * @deny (create) Authenticated user attempting to create a profile with a mismatched ID.
     *     // Example: User with UID 'user123' creating /users/user456.
     * @allow (update) Authenticated user updating their own profile.
     *     // Example: User with UID 'user123' updating /users/user123.
     * @deny (update) Authenticated user attempting to update another user's profile.
     *     // Example: User with UID 'user456' attempting to update /users/user123.
     * @allow (delete) Authenticated user deleting their own profile.
     *     // Example: User with UID 'user123' deleting /users/user123.
     * @deny (delete) Authenticated user attempting to delete another user's profile.
     *     // Example: User with UID 'user456' attempting to delete /users/user123.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId) && resource.data.id == userId && resource != null;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description Enforces user-ownership for devices.
     * @path /users/{userId}/devices/{deviceId}
     * @allow (get) Authenticated user accessing their own device.
     *     // Example: User with UID 'user123' reading /users/user123/devices/device456.
     * @deny (get) Authenticated user attempting to read another user's device.
     *     // Example: User with UID 'user456' attempting to read /users/user123/devices/device456.
     * @allow (list) Authenticated user listing their own devices.
     *     // Example: User with UID 'user123' listing /users/user123/devices.
     * @deny (list) Authenticated user attempting to list another user's devices.
     *     // Example: User with UID 'user456' attempting to list /users/user123/devices.
     * @allow (create) Authenticated user creating a device under their user ID.
     *     // Example: User with UID 'user123' creating /users/user123/devices/device456.
     * @deny (create) Authenticated user attempting to create a device under another user's ID.
     *     // Example: User with UID 'user456' creating /users/user123/devices/device456.
     * @allow (update) Authenticated user updating their own device.
     *     // Example: User with UID 'user123' updating /users/user123/devices/device456.
     * @deny (update) Authenticated user attempting to update another user's device.
     *     // Example: User with UID 'user456' updating /users/user123/devices/device456.
     * @allow (delete) Authenticated user deleting their own device.
     *     // Example: User with UID 'user123' deleting /users/user123/devices/device456.
     * @deny (delete) Authenticated user attempting to delete another user's device.
     *     // Example: User with UID 'user456' attempting to delete /users/user12 Her Daviematron  such user M. Application.
zones sentence of my fire store, at the beginning that is the role in cloud.google permissions.
     */
    match /users/{userId}/devices/{deviceId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isOwner(userId) && resource.data.userId == userId && resource != null;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description Enforces user-ownership for alerts.
     * @path /users/{userId}/devices/{deviceId}/alerts/{alertId}
     * @allow (get) Authenticated user accessing their own alert.
     *     // Example: User with UID 'user123' reading /users/user123/devices/device456/alerts/alert789.
     * @deny (get) Authenticated user attempting to read another user's alert.
     *     // Example: User with UID 'user456' attempting to read /users/user123/devices/device456/alerts/alert789.
     * @allow (list) Authenticated user listing their own alerts.
     *     // Example: User with UID 'user123' listing /users/user123/devices/device456/alerts.
     * @deny (list) Authenticated user attempting to list another user's alerts.
     *     // Example: User with UID 'user456' attempting to list /users/user123/devices/device456/alerts.
     * @allow (create) Authenticated user creating an alert under their device.
     *     // Example: User with UID 'user123' creating /users/user123/devices/device456/alerts/alert789.
     * @deny (create) Authenticated user attempting to create an alert under another user's device.
     *     // Example: User with UID 'user456' creating /users/user123/devices/device456/alerts/alert789.
     * @allow (update) Authenticated user updating their own alert.
     *     // Example: User with UID 'user123' updating /users/user123/devices/device456/alerts/alert789.
     * @deny (update) Authenticated user attempting to update another user's alert.
     *     // Example: User with UID 'user456' attempting to update /users/user123/devices/device456/alerts/alert789.
     * @allow (delete) Authenticated user deleting their own alert.
     *     // Example: User with UID 'user123' deleting /users/user123/devices/device456/alerts/alert789.
     * @deny (delete) Authenticated user attempting to delete another user's alert.
     *     // Example: User with UID 'user456' attempting to delete /users/user123/devices/device456/alerts/alert789.
     * @principle Enforces document ownership and valid device for alerts.
     */
    match /users/{userId}/devices/{deviceId}/alerts/{alertId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId && request.resource.data.deviceId == deviceId;
      allow update: if isOwner(userId) && resource.data.userId == userId && resource.data.deviceId == deviceId && resource != null;
      allow delete: if isOwner(userId) && resource != null;
    }
  }
}