/**
 * @fileoverview Firestore Security Rules for SmartGas Guardian.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for all data. Users can only
 * access their own profile information, the devices they own, and the alerts
 * generated by those devices. No data is publicly accessible.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile information.
 * - /users/{userId}/devices/{deviceId}: Stores devices owned by a specific user.
 * - /users/{userId}/devices/{deviceId}/alerts/{alertId}: Stores alerts for a specific device.
 *
 * Key Security Decisions:
 * - User listing is disallowed.
 * - All write operations are restricted to the owner of the data.
 * - Data consistency between paths and document fields is enforced for user-owned data.
 *
 * Denormalization for Authorization:
 *  - Each Device and Alert has a userId field which MUST match the userId in the path.
 *  This enables simpler and more performant authorization checks.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Protects user profile information.
     * @path /users/{userId}
     * @allow (create) User with UID 'user_abc' can create their own profile.
     * @allow (get) User with UID 'user_abc' can read their own profile.
     * @allow (update) User with UID 'user_abc' can update their own profile.
     * @allow (delete) User with UID 'user_abc' can delete their own profile.
     * @deny (create) User with UID 'user_xyz' cannot create a profile for 'user_abc'.
     * @deny (get) User with UID 'user_xyz' cannot read the profile of 'user_abc'.
     * @principle Enforces document ownership for all operations on user profiles.
     */
    match /users/{userId} {
      // Helper function to check if the request is from the owner of the user profile.
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Protects device information for a specific user.
     * @path /users/{userId}/devices/{deviceId}
     * @allow (create) User with UID 'user_abc' can create a device under their profile.
     * @allow (get) User with UID 'user_abc' can read a device under their profile.
     * @allow (update) User with UID 'user_abc' can update a device under their profile.
     * @allow (delete) User with UID 'user_abc' can delete a device under their profile.
     * @deny (create) User with UID 'user_xyz' cannot create a device for 'user_abc'.
     * @deny (get) User with UID 'user_xyz' cannot read the device of 'user_abc'.
     * @principle Enforces document ownership for all operations on user devices.
     */
    match /users/{userId}/devices/{deviceId} {
      // Helper function to check if the request is from the owner of the device.
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Protects alert information for a specific device and user.
     * @path /users/{userId}/devices/{deviceId}/alerts/{alertId}
     * @allow (create) User with UID 'user_abc' can create an alert for their device.
     * @allow (get) User with UID 'user_abc' can read an alert for their device.
     * @allow (update) User with UID 'user_abc' cannot update an alert for their device (alerts should be immutable).
     * @allow (delete) User with UID 'user_abc' cannot delete an alert for their device.
     * @deny (create) User with UID 'user_xyz' cannot create an alert for 'user_abc'.
     * @deny (get) User with UID 'user_xyz' cannot read the alert of 'user_abc'.
     * @principle Enforces document ownership for all operations on user device alerts.
     */
    match /users/{userId}/devices/{deviceId}/alerts/{alertId} {
      // Helper function to check if the request is from the owner of the alert.
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if false;
      allow delete: if false;
    }
  }
}