/**
 * @description This ruleset enforces a strict user-ownership model for the SmartGas Guardian system.
 *   Users can only access their own data, and devices/alerts are secured under user-specific subcollections.
 * @dataStructure
 *   - /users/{userId}: Stores user profile information, with the document ID matching the Firebase Auth UID.
 *   - /users/{userId}/devices/{deviceId}: Stores devices owned by the user.
 *   - /users/{userId}/devices/{deviceId}/alerts/{alertId}: Stores alerts generated by a specific device.
 * @keySecurityDecisions
 *   - Users can only read and write their own user document and the subcollections under it.
 *   - Listing of users is disallowed.
 *   - Data required for authorization (userId) is denormalized onto the Device and Alert documents to avoid costly `get()` calls in the rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows users to read and write their own user document.
     * @path /users/{userId}
     * @allow (get, create, update, delete) if the request is made by the user with matching UID.
     *   Example: User with UID "user123" can read/write the document /users/user123.
     * @deny (get, create, update, delete) if the request is made by a different user.
     *   Example: User with UID "user456" cannot read/write the document /users/user123.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow create: if isSelfCreate(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
      allow list: if false;
    }

    /**
     * @description Allows users to read and write their own devices.
     * @path /users/{userId}/devices/{deviceId}
     * @allow (get, create, update, delete) if the request is made by the user with matching UID.
     *   Example: User with UID "user123" can read/write the document /users/user123/devices/device456.
     * @deny (get, create, update, delete) if the request is made by a different user.
     *   Example: User with UID "user456" cannot read/write the document /users/user123/devices/device456.
     * @principle Enforces document ownership for all operations on devices.
     */
    match /users/{userId}/devices/{deviceId} {
      allow get: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && resource.data.userId == userId;
      allow delete: if isExistingOwner(userId);
      allow list: if isOwner(userId);
    }

    /**
     * @description Allows users to read and write their own alerts for a specific device.
     * @path /users/{userId}/devices/{deviceId}/alerts/{alertId}
     * @allow (get, create, update, delete) if the request is made by the user with matching UID and the alert's userId matches.
     *   Example: User with UID "user123" can read/write the document /users/user123/devices/device456/alerts/alert789 if the alert's userId is "user123".
     * @deny (get, create, update, delete) if the request is made by a different user or the alert's userId does not match.
     *   Example: User with UID "user456" cannot read/write the document /users/user123/devices/device456/alerts/alert789.
     * @principle Enforces document ownership for all operations on alerts, ensuring data consistency.
     */
    match /users/{userId}/devices/{deviceId}/alerts/{alertId} {
      allow get: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && resource.data.userId == userId;
      allow delete: if isExistingOwner(userId);
      allow list: if isOwner(userId);
    }

    // ------ Helper Functions ------

    /**
     * @description Checks if the request is authenticated.
     * @return True if the request is authenticated; otherwise, false.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the request is made by the owner of the resource.
     * @param userId The user ID to compare against the request's authentication UID.
     * @return True if the request is authenticated and the UID matches the provided userId; otherwise, false.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the request is a self-creation request, where the user is creating their own document.
     * @param userId The user ID to compare against the request's authentication UID.
     * @return True if the request is authenticated, the UID matches the provided userId, and the resource does not yet exist; otherwise, false.
     */
    function isSelfCreate(userId) {
      return isOwner(userId) && getAfter(request).data.id == userId;
    }

    /**
     * @description Checks if the request is made by the existing owner of the resource, ensuring the document exists.
     * @param userId The user ID to compare against the request's authentication UID.
     * @return True if the request is authenticated, the UID matches the provided userId, and the resource exists; otherwise, false.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
  }
}