{
  "entities": {
    "Device": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Device",
      "type": "object",
      "description": "Represents a SmartGas Hub device.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the device.",
          "format": "uuid"
        },
        "macAddress": {
          "type": "string",
          "description": "MAC address of the device (unique identifier).",
          "format": "string"
        },
        "deviceName": {
          "type": "string",
          "description": "User-defined name for the device."
        },
        "wifiSsid": {
          "type": "string",
          "description": "WiFi SSID the device is connected to."
        },
        "email": {
          "type": "string",
          "description": "Email address to send alerts to.",
          "format": "email"
        },
        "mobileNumber": {
          "type": "string",
          "description": "Mobile phone number to send SMS alerts to (optional)."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the device was registered.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp indicating when the device was last updated.",
          "format": "date-time"
        },
        "isActive": {
          "type": "boolean",
          "description": "Indicates if the device is active and monitoring."
        }
      },
      "required": [
        "id",
        "macAddress",
        "createdAt",
        "updatedAt"
      ]
    },
    "Alert": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Alert",
      "type": "object",
      "description": "Represents an alert generated by a device.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the alert.",
          "format": "uuid"
        },
        "deviceId": {
          "type": "string",
          "description": "Reference to Device. (Relationship: Device 1:N Alert)",
          "format": "uuid"
        },
        "alertType": {
          "type": "string",
          "description": "Type of alert (e.g., gas_emergency, gas_warning, gas_normal)."
        },
        "message": {
          "type": "string",
          "description": "Detailed message describing the alert."
        },
        "sensorData": {
          "type": "string",
          "description": "JSON object containing sensor data related to the alert.",
          "format": "string"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the alert was generated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "deviceId",
        "alertType",
        "message",
        "createdAt"
      ]
    },
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the SmartGas Guardian system (optional for multi-user support).",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user.",
          "format": "uuid"
        },
        "email": {
          "type": "string",
          "description": "User's email address (used for login and notifications).",
          "format": "email"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the user account was created.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "email",
        "createdAt"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/devices/{deviceId}",
        "definition": {
          "entityName": "Device",
          "schema": {
            "$ref": "#/backend/entities/Device"
          },
          "description": "Stores device information. Device registration should be open to everyone, but updates should only be allowed by authenticated users or devices.",
          "params": [
            {
              "name": "deviceId",
              "description": "The unique ID of the device."
            }
          ]
        }
      },
      {
        "path": "/devices/{deviceId}/alerts/{alertId}",
        "definition": {
          "entityName": "Alert",
          "schema": {
            "$ref": "#/backend/entities/Alert"
          },
          "description": "Stores alerts generated by a specific device. Includes denormalized 'deviceId' for authorization independence.",
          "params": [
            {
              "name": "deviceId",
              "description": "The unique ID of the device that generated the alert."
            },
            {
              "name": "alertId",
              "description": "The unique ID of the alert."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user information.",
          "params": [
            {
              "name": "userId",
              "description": "The unique ID of the user."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to securely manage devices and alerts for the SmartGas Guardian system. It prioritizes authorization independence and efficient querying. Devices are stored at the top level in a 'devices' collection, while alerts are stored in a subcollection under each device, enabling easy retrieval of alerts for a specific device. The `users` collection is included but not used, since the user requests specify anonymous authentication. This design uses structural segregation and path-based ownership (`/devices/{deviceId}/alerts/{alertId}`).\n\nTo ensure authorization independence (CRITICAL), the `deviceId` is included as a property in each alert document. This eliminates the need for `get()` calls to parent documents when writing security rules for alerts. All alerts in the `alerts` subcollection share the same security requirements (Structural Segregation), simplifying the rules. The path-based ownership (`/devices/{deviceId}/alerts/{alertId}`) makes rules simple and efficient.\n\nQAPs:\nList operations are secure because the alerts subcollection is scoped to each device, allowing retrieval of only the relevant alerts.\nDevice registration should be open to everyone, but updates should only be allowed by authenticated users or devices."
  }
}